#!/bin/bash

# Script para instalar o SafeSign Identity Client e suas dependências legadas.
# Criado em: 2025-07-23
# Versão: 2.1 (Corrigida em 2025-10-06)

# Aborta o script se qualquer comando falhar
set -e

# --- 1. PREPARAÇÃO DO SISTEMA ---
echo "INFO: Atualizando lista de pacotes..."
sudo apt-get update

echo "INFO: Instalando dependências e ferramentas necessárias via APT..."
# Instalamos tudo que for possível diretamente dos repositórios oficiais
# para maior estabilidade e segurança.
sudo apt-get install \
    wget \
    unrar \
    pcscd \
    libccid \
    libjbig0 \
    libpcsclite1 \
    opensc \
    libgdk-pixbuf2.0-0 \
    libwxbase3.0-0v5 \
    libwxgtk3.0-gtk3-0v5 \
    -y

# --- 2. DOWNLOAD DOS PACOTES MANUAIS ---
# Apenas pacotes que não existem nos repositórios atuais (ex: Ubuntu 22.04+)
# serão baixados manualmente.

# Cria um diretório para o download para manter tudo organizado
INSTALL_DIR=~/Downloads/instalador_safesign
mkdir -p "$INSTALL_DIR"
cd "$INSTALL_DIR"
echo "INFO: Arquivos serão baixados em: $INSTALL_DIR"

# libssl1.1 é uma dependência legada, baixada do repositório do Ubuntu 20.04
LIBSSL_DEB="libssl1.1_1.1.1f-1ubuntu2.22_amd64.deb"
LIBSSL_URL="http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/$LIBSSL_DEB"

# Pacote principal da GD
SAFESIGN_RAR="SafeSign_IC_Standard_Linux_3.7.0.0_AET.000_ub2004_x86_64.rar"
SAFESIGN_URL="https://safesign.gdamericadosul.com.br/content/$SAFESIGN_RAR"
SAFESIGN_DEB="SafeSign_IC_Standard_Linux_3.7.0.0_AET.000_ub2004_x86_64.deb"

echo "INFO: Baixando pacotes manuais..."
wget -c "$LIBSSL_URL"
wget -c "$SAFESIGN_URL"

# --- 3. EXTRAÇÃO DO PACOTE PRINCIPAL ---
if [ -f "$SAFESIGN_RAR" ]; then
    echo "INFO: Extraindo o pacote principal do SafeSign..."
    # O -o+ sobrescreve arquivos existentes sem perguntar
    unrar x -o+ "$SAFESIGN_RAR"
else
    echo "ERRO: Download do arquivo $SAFESIGN_RAR falhou. Abortando."
    exit 1
fi

# --- 4. INSTALAÇÃO DOS PACOTES .DEB ---
echo "INFO: Iniciando a instalação dos pacotes .deb na ordem correta."

# 1. Instala a dependência legada primeiro
echo "INFO: Instalando libssl1.1..."
sudo dpkg -i "$LIBSSL_DEB"

# 2. Instala o pacote principal
if [ -f "$SAFESIGN_DEB" ]; then
    echo "INFO: Instalando o SafeSign Identity Client..."
    sudo dpkg -i "$SAFESIGN_DEB"
else
    echo "ERRO: O arquivo $SAFESIGN_DEB não foi encontrado após a extração. Abortando."
    exit 1
fi

# --- 5. FINALIZAÇÃO E VERIFICAÇÃO ---
echo "INFO: Corrigindo quaisquer dependências quebradas..."
# Este comando é crucial para resolver problemas após a instalação manual com dpkg.
sudo apt-get --fix-broken install -y

echo "INFO: Ativando e iniciando o serviço de smartcard (pcscd)..."
sudo systemctl enable pcscd.socket
sudo systemctl start pcscd.socket

echo "--------------------------------------------------"
echo "INFO: Instalação finalizada com sucesso!"
echo "INFO: Para verificar se o token é reconhecido, insira-o na leitora agora."
sleep 3
echo "INFO: Executando 'tokenadmin -l' para listar tokens..."
tokenadmin -l
echo "--------------------------------------------------"
